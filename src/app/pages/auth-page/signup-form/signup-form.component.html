<form
    *ngIf="!usernameChoosed; else signUp"
    [formGroup]="usernameForm"
    (ngSubmit)="setUsername()"
>
    <h2>Choose your username</h2>
    <div
        class="form-control"
        [ngClass]="{
            invalid:
                usernameForm.get('username').touched &&
                usernameForm.get('username').invalid
        }"
    >
        <label for="username">Username</label>
        <input
            id="username"
            type="text"
            maxlength="20"
            autocomplete="off"
            formControlName="username"
        />
        <div
            *ngIf="
                usernameForm.get('username').touched &&
                usernameForm.get('username').invalid
            "
            class="validation"
        >
            <small *ngIf="usernameForm.get('username').errors.required">
                Field is required
            </small>
            <small *ngIf="usernameForm.get('username').errors.pattern">
                Username must contain only latin letters, numbers, and
                underscores
            </small>
            <small *ngIf="usernameForm.get('username').errors.usernameExists">
                username {{ usernameForm.get("username").value }} is taken
            </small>
        </div>
    </div>

    <button
        type="submit"
        [disabled]="usernameForm.pending || usernameForm.invalid || submitted"
    >
        Submit
    </button>
</form>
<ng-template #signUp>
    <form
        *ngIf="!newUserRegistered; else addProfileData"
        [formGroup]="signUpForm"
        (ngSubmit)="registrateNewUser()"
    >
        <h2>Registration</h2>
        <div
            class="form-control"
            [ngClass]="{
                invalid:
                    signUpForm.get('email').touched &&
                    signUpForm.get('email').invalid
            }"
        >
            <label for="email">Email</label>
            <input
                id="email"
                type="email"
                maxlength="30"
                formControlName="email"
            />
            <div
                *ngIf="
                    signUpForm.get('email').touched &&
                    signUpForm.get('email').invalid
                "
                class="validation"
            >
                <small *ngIf="signUpForm.get('email').errors.required">
                    Field is required
                </small>
                <small *ngIf="signUpForm.get('email').errors.isEmail">
                    Invalid email
                </small>
            </div>
        </div>

        <div
            class="form-control"
            [ngClass]="{
                invalid:
                    signUpForm.get('password').touched &&
                    signUpForm.get('password').invalid
            }"
        >
            <label for="password">Password</label>
            <input
                id="password"
                type="{{ showPasswordValue ? 'text' : 'password' }}"
                maxlength="30"
                formControlName="password"
            />
            <i (click)="showHidePassword('showPasswordValue')">
                {{ showPasswordValue ? "hide" : "show" }}
            </i>
            <div
                *ngIf="
                    signUpForm.get('password').touched &&
                    signUpForm.get('password').invalid
                "
                class="validation"
            >
                <small *ngIf="signUpForm.get('password').errors.required">
                    Field is required
                </small>
                <small *ngIf="signUpForm.get('password').errors.minlength">
                    {{ onMinLengthError("password") }}
                </small>
            </div>
        </div>

        <div
            class="form-control"
            [ngClass]="{
                invalid:
                    signUpForm.get('confirmPass').touched &&
                    signUpForm.get('confirmPass').invalid
            }"
        >
            <label for="confirmPass">Repeat password</label>
            <input
                id="confirmPass"
                type="{{ showConfirmPassValue ? 'text' : 'password' }}"
                maxlength="30"
                formControlName="confirmPass"
            />
            <i (click)="showHidePassword('showConfirmPassValue')">
                {{ showConfirmPassValue ? "hide" : "show" }}
            </i>
            <div
                *ngIf="
                    signUpForm.get('confirmPass').touched &&
                    signUpForm.get('confirmPass').invalid
                "
                class="validation"
            >
                <small *ngIf="signUpForm.get('confirmPass').errors.required">
                    Field is required
                </small>
                <small *ngIf="signUpForm.get('confirmPass').errors.minlength">
                    {{ onMinLengthError("confirmPass") }}
                </small>
            </div>
        </div>

        <div *ngIf="signUpForm.errors" class="validation">
            <small *ngIf="signUpForm.errors.mismatch">
                Passwords do not match
            </small>
        </div>

        <button type="button" [disabled]="submitted" (click)="backToUsername()">
            Back to username
        </button>
        <button type="submit" [disabled]="signUpForm.invalid || submitted">
            Registrate
        </button>
    </form>
    <ng-template #addProfileData>
        <div>
            <div>
                <div [class.user-avatar]="!pickerService.showCropper">
                    <app-img-picker
                        cropperAriaShape="rounded"
                        [croppedSizes]="croppedAvatarSizes"
                        src="../../../../assets/avatar.jpg"
                    ></app-img-picker>
                </div>
                <button
                    type="button"
                    [disabled]="
                        !pickerService.showCropper &&
                        !pickerService.showNewImage
                    "
                    (click)="pickerService.resetImage()"
                >
                    Remove file
                </button>
                <button
                    type="button"
                    (click)="pickerService.triggerFileUploadInput()"
                >
                    Upload file
                </button>
                <button
                    type="button"
                    [disabled]="!pickerService.showCropper"
                    (click)="pickerService.submitCroppedImage()"
                >
                    cropper submit changes
                </button>
            </div>
            <form [formGroup]="profileDataForm">
                <p>This information will be open for everyone</p>
                <div class="form-control">
                    <label for="name">Name</label>
                    <input
                        id="name"
                        type="text"
                        maxlength="30"
                        autocomplete="off"
                        formControlName="name"
                    />
                </div>
                <div class="form-control">
                    <label for="website">Website</label>
                    <input
                        id="website"
                        type="text"
                        maxlength="30"
                        autocomplete="off"
                        formControlName="website"
                    />
                </div>
                <div class="form-control">
                    <label for="bio">Short bio</label>
                    <input
                        id="bio"
                        type="text"
                        maxlength="70"
                        autocomplete="off"
                        formControlName="bio"
                    />
                    <small>
                        {{ profileDataForm.get("bio") }}
                    </small>
                </div>
                <div class="buttons">
                    <button type="button" (click)="skipEnteringProfileData()">
                        Skip
                    </button>
                    <button
                        type="button"
                        [disabled]="profileDataForm.invalid || submitted"
                        (click)="saveProfileData()"
                    >
                        Save
                    </button>
                </div>
            </form>
        </div>
    </ng-template>
</ng-template>
